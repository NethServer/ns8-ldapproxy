#!/usr/bin/env python3

#
# Copyright (C) 2021 Nethesis S.r.l.
# http://www.nethesis.it - nethserver@nethesis.it
#
# This script is part of NethServer.
#
# NethServer is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License,
# or any later version.
#
# NethServer is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with NethServer.  If not, see COPYING.
#

import agent
import cluster.userdomains
import os
import json

agent_id = os.environ['AGENT_ID']
node_id = int(os.environ['NODE_ID'])

domains = cluster.userdomains.list_domains(agent.redis_connect(use_replica=True))
rdb = agent.redis_connect(privileged=True)
domain_port = rdb.hgetall(f'{agent_id}/data/domain_port')
released_ports = rdb.smembers(f'{agent_id}/data/released_ports')
changed_domains = [] # for multi-domain new event format, single-call
compatibility_domain = None # for single-domain old event format compatibility

# copy the key list, to alter the dict in the FOR-loop:
domains_with_port = list(domain_port.keys())
for domain in domains_with_port:
    # If the domain does not exist anymore in the cluster, release its
    # allocated port.
    if not domain in domains:
        print(f"Release TCP port {domain_port[domain]} allocated for old domain {domain}")
        released_ports.add(domain_port.pop(domain)) # save port number for the future
        changed_domains.append(domain)

for domain in domains:
    # If the domain has no port allocation, allocate a TCP port to it.
    if not domain in domain_port:
        if released_ports:
            nport = released_ports.pop() # reuse old ports
        else:
            # Ask the local node to allocate us one more port
            nport, _ = agent.allocate_ports(ports_number=1, protocol="tcp", keep_existing=True)
        domain_port[domain] = str(nport)
        changed_domains.append(domain)
        if compatibility_domain is None:
            compatibility_domain = domain
        print(f"Allocating TCP port {nport} to {domain}...")

#
# Persist changes to Redis and raise event for applications
#
if len(changed_domains) > 0:
    with rdb.pipeline() as trx:
        trx.delete(f'{agent_id}/data/domain_port')
        if domain_port:
            trx.hset(f'{agent_id}/data/domain_port', mapping=domain_port)
        trx.delete(f'{agent_id}/data/released_ports')
        if released_ports:
            trx.sadd(f'{agent_id}/data/released_ports', *released_ports)
        trx.publish(f'{agent_id}/event/user-domain-changed', json.dumps({
            "node_id": node_id,
            "domain": compatibility_domain or changed_domains[0],
            "domains": changed_domains,
        }))
        trx.execute()
    print(f"Saved the new domain/port allocation map")
